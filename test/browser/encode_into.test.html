<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>test</title>
    <script type="module">
import test from "./test.mjs";
import { Ms932Encoder } from "../../dist/index.js";

test.it("encodeInto(string, Object)", () => {
  // fallback
  const ms932Encoder1 = new Ms932Encoder({fatal:true});
  test.assert.throws(() => {
    ms932Encoder1.encodeInto("\u0081", new Uint8Array());
  }, {
    message: "EncodingError U+0081"
  });

  const ms932Encoder2 = new Ms932Encoder(/*{fatal: false}*/);

  const b1 = new Uint8Array(4);
  const r1 = ms932Encoder2.encodeInto("\u0081", b1);
  test.assert.strictEqual([...b1].join(","), "63,0,0,0");
  test.assert.strictEqual(r1.read, 1);
  test.assert.strictEqual(r1.written, 1);

  const b2 = new Uint8Array(4);
  const r2 = ms932Encoder2.encodeInto("\u{29e3d}", b2);
  test.assert.strictEqual([...b2].join(","), "63,0,0,0");
  test.assert.strictEqual(r2.read, 2);
  test.assert.strictEqual(r2.written, 1);

});

test.it("encodeInto(string)", () => {
  const ms932Encoder = new Ms932Encoder();

  const b2 = new Uint8Array(20);
  const r2 = ms932Encoder.encodeInto("あabcいうえお\u{29e3d}123?", b2);
  test.assert.strictEqual([...b2].join(","), "130,160,97,98,99,130,162,130,164,130,166,130,168,63,49,50,51,63,0,0");
  test.assert.strictEqual(r2.read, 14);
  test.assert.strictEqual(r2.written, 18);

  const td = new TextDecoder("shift_jis");
  test.assert.strictEqual(td.decode(b2.subarray(0,r2.written)), "あabcいうえお?123?");

});

test.exec();
    </script>
  </head>
  <body>
  </body>
</html>
